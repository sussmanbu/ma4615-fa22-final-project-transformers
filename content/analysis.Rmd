---
title: Analysis
description:
toc: true
featuredVideo:
featuredImage: images/Woman_analysis.jpeg
draft: false
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE, results = 'hide'}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(modelr))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(tmap))
suppressPackageStartupMessages(library(dplyr))
load(here::here("dataset", "abortionDataClean.RData"))
load(here::here("dataset", "MaxStateAff.RData"))
us_states <- 
  st_read(here::here("dataset","cb_2019_us_state_20m/cb_2019_us_state_20m.shp"), quiet = TRUE)
geog_loc <- 
  read_csv(here::here("dataset","StateGeography.csv"))
us_regions <- 
  st_read(here::here("dataset","cb_2018_us_division_20m/cb_2018_us_division_20m.shp"), quiet = TRUE)
```

This comes from the file `content/analysis.Rmd`.

# Data Analysis 

* Because Roe v. Wade is a highly politicized issue that has gained media attention that has varied over the years, we wanted to analyze pregnancy and abortion rates in the context of political affiliation and chronological year. In addition to political affiliation and changes over time, we are also interested in how these changing factors influence pregnancy and abortion rates by year. 
* We are interested in investigating the degree to which pregnancy and abortion rates have changed over time and how these trends have changed depending on age group of the mother within the context of political affiliation. 
* Our main questions that we hope to answer with our analysis and data modeling are: How does state's party affiliation affect abortion rates, births, and miscarriages? How have the age of pregnant mothers and abortion rates changed over time?

## Initial Analysis

### Graph 1: Average Abortion Rate By State Affiliation

```{r, echo = FALSE, warning = FALSE, message = FALSE}
abortionDataClean %>% 
  group_by(state) %>% 
  summarise(AverageAbortionRate = mean(AbortionRate, na.rm=TRUE)) %>% 
  inner_join(MaxStateAff) %>% 
  ggplot() + 
  stat_summary(aes(x = reorder(state, AverageAbortionRate), y = AverageAbortionRate, fill = as.factor(Affiliation)), geom = "bar") + 
  coord_flip() + 
  scale_fill_viridis_d(option = "cividis") + 
  labs(title = 'Average Abortion Rate by State Affiliation', x = 'State\n', y = '\nAverage Abortion Rate', fill = "Affliation") + 
  ggthemes::theme_economist() +
  theme(axis.text.y = element_text(size = 7), axis.title = element_text(size = 10), legend.position = 'right', legend.text = element_text(size = 8))
```

* We began our analysis by graphing the average abortion rate of each state as a horizontal bar graph with each bar color coded by state affiliation(Democrats, Republicans, or Divided).

* From our plot, we saw some noticeable trends. The states with the highest average abortion rates were almost entirely Democratically affiliated. The states with the lowest average abortion rates were almost entirely Republican affiliated.

### Graph 2: Average Pregnancy Rate By State Affiliation

```{r, echo = FALSE, warning = FALSE, message = FALSE}
abortionDataClean %>% 
  group_by(state) %>% 
  summarise(AveragePregnancyRate = mean(PregnancyRate, na.rm=TRUE)) %>% 
  inner_join(MaxStateAff) %>% 
  ggplot() + 
  stat_summary(aes(x = reorder(state, AveragePregnancyRate), y = AveragePregnancyRate, fill = as.factor(Affiliation)), geom = "bar") + 
  coord_flip() + 
  scale_fill_viridis_d(option = "cividis") + 
  labs(title = 'Average Pregnancy Rate by State Affiliation', x = 'State\n', y = '\nAverage Pregnancy Rate', fill = "Affliation") + 
  ggthemes::theme_economist() +
  theme(axis.text.y = element_text(size = 7), axis.title = element_text(size = 10), legend.position = 'right', legend.text = element_text(size = 8))
```

Stuff about Average pregnancy Rate by State Affiliation

### Graph 3: Average Pregnancy Rate by Age group 

```{r, echo = FALSE, warning = FALSE, message = FALSE}
abortionDataClean %>% 
  group_by(year, Age) %>% 
  summarise(AveragePregRate = mean(PregnancyRate, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = AveragePregRate, color = as.factor(Age))) + 
  geom_line() + 
  labs(title = 'Average Pregnancy Rate by Age Group from 1973 to 2017', x = 'Year', y = 'Average Pregnancy Rate', color = "Age Group") + 
  ggthemes::theme_economist() +
  theme(legend.position = 'right', legend.text = element_text(size = 8)) +
  scale_color_viridis_d(option = "turbo")
```

Next, we wanted to see the average pregnancy rate for different age groups over the last 50 years. 

From our graph, we can see each age group as its own line that we can look at individually or all together. 

### Graph 4: Average Abortion Rate by Age group 

```{r, echo = FALSE, warning = FALSE, message = FALSE}
abortionDataClean %>% 
  group_by(year, Age) %>% 
  summarise(AverageAbortionRate = mean(AbortionRate, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = AverageAbortionRate, color = as.factor(Age))) + 
  geom_line() + 
  labs(title = 'Average Abortion Rate by Age Group from 1973 to 2017', x = 'Year', y = 'Average Abortion Rate', color = "Age Group") + 
  ggthemes::theme_economist() +
  theme(legend.position = 'right', legend.text = element_text(size = 8)) +
  scale_color_viridis_d(option = "turbo")
```

Stuff about Average Abortion Rate by Age group

### Graph 5: Average Pregnancy Rate by Age group for Different Political Affiliations

```{r, echo = FALSE, warning = FALSE, message = FALSE}
abortionDataClean %>% 
  group_by(state, year, Age) %>% 
  summarise(AveragePregRate = mean(PregnancyRate, na.rm = TRUE)) %>% 
  ungroup() %>% 
  inner_join(MaxStateAff) %>% 
  filter(Affiliation %in% c("DEMOCRAT", "REPUBLICAN")) %>% 
  ggplot(aes(x = year, y = AveragePregRate, color = as.factor(Age))) + 
  geom_line() + 
  facet_wrap(~ as.factor(Affiliation)) +
  labs(title = 'Average Pregnancy Rate by Age Group for Different Political Affiliations', x = 'Year', y = 'Average Pregnancy Rate', color = "Age Group")
```

Stuff about Average Pregnancy Rate by Age Group for Differnet Political Affiliations

### Graph 6: Average Abortion Rate by Age group for Different Political Affiliations

```{r, echo = FALSE, warning = FALSE, message = FALSE}
abortionDataClean %>% 
  group_by(state, year, Age) %>% 
  summarise(AverageAbortionRate = mean(AbortionRate, na.rm = TRUE)) %>% 
  ungroup() %>% 
  inner_join(MaxStateAff) %>% 
  filter(Affiliation %in% c("DEMOCRAT", "REPUBLICAN")) %>% 
  ggplot(aes(x = year, y = AverageAbortionRate, color = as.factor(Age))) + 
  geom_line() + 
  facet_wrap(~ as.factor(Affiliation)) +
  labs(title = 'Average Abortion Rate by Age Group for Different Political Affiliations', x = 'Year', y = 'Average Abortion Rate', color = "Age Group")
```

Stuff about Average Abortion Rate by Age Group for Different Political Affiliations


## Modeling

### Graph 7: Average Pregnancy Rate of Teenagers over the last 50 years

```{r, echo = FALSE, warning = FALSE, message = FALSE}

teenPregData <- 
  abortionDataClean %>% 
  group_by(year, Age) %>% 
  summarise(AveragePregRate = mean(`PregnancyRate`, na.rm = TRUE)) %>% 
  filter(Age %in% c("<15", "15-17", "18-19")) 

teenPregMod <- 
  lm(AveragePregRate ~ year, data = teenPregData)

beta <- 
  coef(teenPregMod)

teenPregData <- 
  teenPregData %>% 
  add_predictions(teenPregMod)

teenPregData %>% 
  ggplot(aes(x = year)) + 
  geom_point(aes(y = AveragePregRate, color = as.factor(Age))) + 
  geom_line(aes(y = pred), data = teenPregData, color = "red", size = 1) + 
  labs(title = 'Average Pregnancy Rate of Teenagers from 1973 to 2017', x = '\nYear', y = 'Average Pregnancy Rate\n', color = "Age Group") + 
  ggthemes::theme_economist() +
  theme(legend.position = 'right', legend.text = element_text(size = 8)) + 
  scale_color_viridis_d(option = "plasma")
```

We wanted to see the trend of teen pregnancy, so we created a model which predicts the Average Pregnancy Rate among teenagers. One limitation of this model is that it does not include any information on abortion or political affiliation. However, paired with our other visualizations, this linear model provides foundational information regarding the potential relationships between teen pregnancies, abortion, and abortion laws. Importantly, the trend line helps us to visualize what we might see in years to come.

### Graph 8: Residuals for Teen Pregnancy Model

```{r, echo = FALSE, warning = FALSE, message = FALSE}
teenPregData %>% 
  add_residuals(teenPregMod) %>% 
  ggplot(aes(year, resid)) + 
  geom_ref_line(h=0) + 
  geom_point(aes(color = as.factor(Age))) + 
  labs(title = 'Residuals for Teen Pregnancy Model', x = '\nYear', y = 'Residual\n', color = "Age Group") + 
  ggthemes::theme_economist() +
  theme(legend.position = 'right', legend.text = element_text(size = 8)) + 
  scale_color_viridis_d(option = "plasma")
```

This supplementary graph shows us how well our model is predicting Average Teen Pregnancy Rates. 


## Spatial Maps

### Map 1: Political Affiliation by State
```{r readshapefile, echo = FALSE, warning = FALSE, message = FALSE}
not_included <-
  c("Guam", "Commonwealth of the Northern Mariana Islands",
    "American Samoa", "Puerto Rico", "United States Virgin Islands")

us_states <- 
  us_states %>%
  filter(!(NAME %in% not_included))
```

```{r convert to EPSG 2163, echo = FALSE}
epsg_us <- 
  2163

us_states <- 
  st_transform(us_states, epsg_us)
```

```{r join US states, geographic location and state affiliation datasets, warning=FALSE, message=FALSE, echo = FALSE,}
states_geog <- 
  inner_join(us_states, geog_loc, by = c("STUSPS" = "State", "NAME" = "FullStateName"))

states_geog_aff <- 
  inner_join(states_geog, MaxStateAff, by = c("STUSPS" = "state"))
```

```{r calculate overall abortion rate for each state, echo = FALSE,}
state_abortion_rate <- 
  abortionDataClean %>% 
  replace(is.na(.), 0) %>% 
  group_by(state) %>% 
  select(state, Abortions, Population) %>% 
  mutate(state, total_population = sum(Population), total_abortions = sum(Abortions), overall_abortion_rate = total_abortions/total_population) %>% 
  select(state, total_abortions, total_population, overall_abortion_rate)

state_abortion_rate <- 
  state_abortion_rate[!duplicated(state_abortion_rate$state), ]
```

```{r join overall abortion rate dataset with state, geographic location and political affiliation dataset, warning=FALSE, message=FALSE, echo = FALSE,}
state_data <- 
  inner_join(states_geog_aff, state_abortion_rate, by = c("STUSPS" = "state")) %>%
  select(NAME, STUSPS, GeographicRegion, Affiliation, overall_abortion_rate, geometry)
```

```{r plot map by state, fig.width=80, fig.height=80, warning=FALSE, message=FALSE, echo = FALSE,}
tmap_mode("view")
colours <- 
  c("#00AEF3", "#808080", "#E81B23")

tm_shape(state_data) + 
  tm_polygons(col = "overall_abortion_rate", title = "Overall Abortion Rate by State") +
  tm_layout(frame = FALSE, legend.outside = TRUE, legend.title.size = 2, legend.text.size = 1.5)
  
tm_shape(state_data) + 
  tm_polygons(col = "Affiliation", title = "Political Affiliation by State", palette = colours) +
  tm_layout(frame = FALSE, legend.outside = TRUE, legend.title.size = 2, legend.text.size = 1.5)
```

Stuff about map 1

### Map 2: Overall Abortion Rate by Region

```{r load region data, warning=FALSE, message=FALSE, echo = FALSE}
us_regions <- 
  us_regions %>% 
  st_transform(epsg_us)
```

```{r get overall abortion data by region, warning=FALSE, message=FALSE, echo = FALSE}
region_abortion_rate <- 
  inner_join(states_geog_aff, abortionDataClean, by = c("STUSPS" = "state")) %>% 
  replace(is.na(.), 0) %>% 
  group_by(GeographicRegion) %>% 
  select(GeographicRegion, Abortions, Population) %>% 
  mutate(GeographicRegion, total_population = sum(Population), total_abortions = sum(Abortions), overall_abortion_rate = total_abortions/total_population) %>% 
  select(GeographicRegion, total_abortions, total_population, overall_abortion_rate) %>% 
  st_drop_geometry()

region_abortion_rate <- 
  region_abortion_rate[!duplicated(region_abortion_rate$GeographicRegion), ]

region_abortion_rate <- 
  region_abortion_rate[!duplicated(region_abortion_rate$GeographicRegion), ]

region_abortion_rate <- 
  st_set_geometry(region_abortion_rate, us_regions$geometry)
```

```{r plot map by geographic location, fig.width=80, fig.height=80, warning=FALSE, message=FALSE, echo = FALSE}
region_data <- 
  region_abortion_rate %>% 
   select(GeographicRegion, overall_abortion_rate, geometry)

tmap_mode("view")

tm_shape(region_data) + 
  tm_polygons(col = "overall_abortion_rate", title = "Overall Abortion Rate by Region") +
  tm_shape(state_data) + 
  tm_borders() +
  tm_layout(frame = FALSE, legend.outside = TRUE, legend.title.size = 2, legend.text.size = 1.5)
```

Stuff about map 2